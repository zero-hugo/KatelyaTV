# 管理员页面访问问题修复说明

## 问题描述

在修复 TVBox 配置生成问题时，我将数据库表名从 `admin_config` 更新为 `admin_configs`，但现有的数据库还是使用旧的表名，导致管理员页面无法加载配置，显示"获取配置失败: 获取管理员配置失败"。

## 修复方案

### 1. 向后兼容性修复

我修改了 `src/lib/d1.db.ts` 中的 `getAdminConfig()` 和 `setAdminConfig()` 方法：

- **读取配置时**：先尝试新表名 `admin_configs`，如果失败则回退到旧表名 `admin_config`
- **保存配置时**：先尝试新表名，失败则使用旧表名
- **自动迁移**：检测到旧表存在时，自动创建新表并迁移数据

### 2. 自动迁移机制

添加了 `migrateAdminConfigIfNeeded()` 方法：

- 检查新表 `admin_configs` 是否存在
- 如果不存在且旧表 `admin_config` 有数据，则自动迁移
- 保留旧表以确保数据安全

### 3. 测试验证

创建了测试端点 `/api/test/admin-config` 用于验证配置读取是否正常。

## 使用方法

### 立即修复（无需任何操作）

- 现在系统会自动兼容旧的 `admin_config` 表
- 首次访问管理员页面时会自动尝试迁移数据
- 无需手动运行任何脚本

### 验证修复效果

1. 访问 `/admin` 页面，应该能正常加载
2. （可选）访问 `/api/test/admin-config` 查看详细状态

### 如果仍有问题

如果问题持续存在，可能的原因和解决方案：

1. **权限问题**：确保数据库有创建表的权限
2. **数据库连接**：检查数据库连接是否正常
3. **环境变量**：确认 `NEXT_PUBLIC_STORAGE_TYPE` 设置正确

## 技术细节

### 兼容性逻辑

```typescript
// 读取时的回退机制
try {
  // 尝试新表
  result = await db.prepare('SELECT ... FROM admin_configs ...').first();
} catch {
  // 回退到旧表
  result = await db.prepare('SELECT ... FROM admin_config ...').first();
}
```

### 自动迁移过程

1. 检查 `admin_configs` 表是否存在
2. 如果不存在，检查 `admin_config` 表是否有数据
3. 创建新表结构
4. 复制旧表数据到新表
5. 保留旧表以防回滚需要

## 部署建议

### 生产环境

- 此修复确保了零停机时间
- 数据迁移在后台自动进行
- 旧表不会被删除，确保数据安全

### 开发环境

- 可以安全地测试新功能
- 如需要，可以手动运行迁移脚本

## 回滚方案

如果需要回滚到旧版本：

1. 旧表 `admin_config` 仍然存在
2. 旧版本代码仍然可以正常工作
3. 数据不会丢失

此修复确保了完全的向后兼容性，同时为未来的功能升级做好准备。
